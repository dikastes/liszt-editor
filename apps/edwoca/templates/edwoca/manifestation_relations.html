{% extends 'edwoca/base.html' %}

{% load static %}
{% load i18n %}

{% block modals %}
    {% if not object.is_singleton %}
        {% for item_form in item_forms %}
            <div class="modal" role="dialog" id="item-modal-{{ item_form.item.id }}">
                <div class="modal-box">
                    <h3 class="text-lg font-bold">
                        {% translate 'edit item' %}
                    </h3>
                    <form method="post">
                        {% csrf_token %}
                        <h3>
                            {% translate 'locations' %}
                        </h3>

                        {% comment %}
                            if not every management form is displayed here, there will be trouble in
                            the other forms after a new formset form has been added
                        {% endcomment %}
                        <div class="hidden">
                        {% for item_form in item_forms %}
                            {{ item_form.signature_formset }}
                        {% endfor %}
                        </div>

                        {% for form in item_form.signature_formset %}
                            <div class="signature-form">
                                {{ form.as_daisy }}
                            </div>
                        {% endfor %}

                        <div class="flex gap-5">
                            <div class="flex-1"></div>
                            <input type="submit" name="add_signature_{{ item_form.item.id }}" value="Signatur hinzufügen" class="flex-0 btn">
                            <input type="submit" name="save_changes" value="Speichern" class="flex-0 btn btn-primary">
                            <div class="modal-action flex-0 m-0">
                                <a href="#" class="btn">X</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        {% endfor %}
        <div class="modal" role="dialog" id="item-modal-new">
            <div class="modal-box">
                <h3 class="text-lg font-bold">
                    {% translate 'create item' %}
                </h3>
                <form method="post" action="{% url 'edwoca:manifestation_update' object.id %}">
                    {% csrf_token %}
                    <h3>
                        {% translate 'locations' %}
                    </h3>
                    {{ new_signature_formset.management_form }}
                    {% for form in new_signature_formset %}
                        <div class="signature-form">
                            {{ form.as_daisy }}
                        </div>
                    {% endfor %}

                    <div class="flex gap-5">
                        <div class="flex-1"></div>
                        <input type="submit" name="save_changes" value="Speichern" class="flex-0 btn btn-primary">
                        <div class="modal-action flex-0 m-0">
                            <a href="#" class="btn">X</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block content %}

{% include 'edwoca/partials/manifestation/preview-divs/relations_prolog.html' %}

{% if object.is_collection %}
    <h2 class="mb-5">
        {% translate 'collection parts' %}
    </h2>

    {% if object.collection_parts.all %}
        <ul class="list-disc m-5">
            {% for collection_part in object.collection_parts.all %}
                <li class="list-disc">
                    <a href="{% url 'edwoca:manifestation_relations' collection_part.id %}">
                        {{ collection_part }}
                    </a>
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="flex gap-5">
        <div class="flex-1"></div>
        <a class="flex-0 btn btn-outline" href="{% url 'edwoca:part_create' object.id %}">
            {% translate 'create print part' %}
        </a>
        <a class="flex-0 btn btn-outline" href="{% url 'edwoca:singleton_part_create' object.id %}">
            {% translate 'create manuscript part' %}
        </a>
    </div>

    <h2 class="mb-5"> 
        {% translate 'collection components' %}
    </h2>

    {% if object.collection_components.all %}
        <ul class="list-disc m-5">
            {% for collection_component in object.collection_components.all %}
                <li class="list-disc">
                    <a href="{% url 'edwoca:manifestation_relations' collection_component.id %}">
                        {{ collection_component }}
                    </a>
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="flex gap-5">
        <div class="flex-1"></div>
        <a class="flex-0 btn btn-outline" href="{% url 'edwoca:component_create' object.id %}">
            {% translate 'create print component' %}
        </a>
        <a class="flex-0 btn btn-outline" href="{% url 'edwoca:singleton_component_create' object.id %}">
            {% translate 'create manuscript component' %}
        </a>
    </div>

{% else %}
    <h2 class="mb-5"> 
        {% translate 'collection' %}
    </h2>

    {% if object.part_of %}
        <p>
            {% translate 'this object is part of' %}
            <a class="font-bold" href="{% url 'edwoca:manifestation_relations' object.part_of.id %}">
                → {{ object.part_of }}.
            </a>
        </p>
        <div class="flex my-5">
            <div class="flex-1"></div>
            <form class="flex-0" method="post" action="{% url 'edwoca:collection_remove' object.id %}">
                {% csrf_token %}
                <input type="submit" class="btn btn-primary btn-outline btn-sm" value="{% translate 'remove collection' %}" />
            </form>
        </div>
        {% else %}
        {% if object.component_of %}
            <p>
                {% translate 'this object is component of' %}
                <a class="font-bold" href="{% url 'edwoca:manifestation_relations' object.component_of.id %}">
                    → {{ object.component_of }}.
                </a>
            </p>
            <div class="flex my-5" method="post">
                <div class="flex-1"></div>
                <form class="flex-0" action="{% url 'edwoca:collection_remove' object.id %}">
                    {% csrf_token %}
                    <input type="submit" class="btn btn-primary btn-outline btn-sm" value="{% translate 'remove collection' %}" />
                </form>
            </div>
        {% else %}
            <form action="{% url 'edwoca:manifestation_relations' object.id %}" class="w-full flex">
                {{ collection_search_form.q }}
                <input type="submit" value="{% translate 'search' %}" class="btn btn-outline border-l-0" />
            </form>
            {% if found_collections %}
                <ul class="border border-black p-2 h-32 overflow-auto">
                    {% for found_collection in found_collections %}
                        <li>
                            {{ found_collection.object }}
                            <div class="flex mb-2 mx-2 gap-2">
                                <form class="flex-0">
                                    <input type="hidden" name="link-collection-part" value="{{ found_collection.object.id }}" />
                                    <input type="submit" class="btn btn-outline btn-sm" value="{% translate 'is part of' %}" />
                                </form>
                                <form class="flex-0">
                                    <input type="hidden" name="link-collection-component" value="{{ found_collection.object.id }}" />
                                    <input type="submit" class="btn btn-outline btn-sm" value="{% translate 'is component of' %}" />
                                </form>
                            </div>
                        </li>
                    {% empty %}
                        <li>
                            <em>
                                {% translate 'no search results' %}
                            </em>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endif %}
    {% endif %}
{% endif %}

<h2 class="mb-5"> 
    {% translate 'manuscripts' %}
</h2>

<h3>
    {% translate 'outbound' %}
</h3>

<em>
    {% translate 'links created by the search form will be displayed here' %}
</em>

<ul class="list-disc ml-5 my-5">
    {% for manifestation_relation in object.source_manifestation_of.all %}
        {% if manifestation_relation.target_manifestation.is_singleton %}
            <li>
                <div class="flex items-center">
                    <a href="{% url 'edwoca:manifestation_relations' manifestation_relation.target_manifestation.id %}" class="flex-1">
                        {{ manifestation_relation.target_manifestation }} ({{ manifestation_relation.get_label_display }})
                    </a>
                    <form method="post" action="{% url 'edwoca:related_manifestation_remove' manifestation_relation.id %}" class="flex-0 ml-4">
                        {% csrf_token %}
                        <input type="submit" class="btn btn-sm btn-outline text-primary" value="{% translate 'remove' %}">
                    </form>
                </div>
            </li>
        {% endif %}
    {% endfor %}
</ul>

<h3>
    {% translate 'inbound' %}
</h3>
<em>
    {% translate 'manuscripts linked to this object will be displayed here.' %}
</em>
<ul class="list-disc ml-5 my-5">
    {% for manifestation_relation in object.target_manifestation_of.all %}
        {% if manifestation_relation.source_manifestation.is_singleton %}
            <li>
                <a href="{% url 'edwoca:manifestation_relations' manifestation_relation.source_manifestation.id %}" class="flex-1">
                    {{ manifestation_relation.source_manifestation }} ({{ manifestation_relation.get_label_display }})
                </a>
            </li>
        {% endif %}
    {% endfor %}
</ul>

<form action="{% url 'edwoca:manifestation_relations' object.id %}" method="post" class="w-full flex">
    {% csrf_token %}
    {{ manuscript_search_form.q }}
    <input type="submit" value="{% translate 'search' %}" class="btn btn-outline border-l-0" />
</form>

{% if manuscript_query %}
    <ul class="border border-black p-2 h-32 overflow-auto">
        {% for found_manuscript in found_manuscripts %}
            <li>
                {{ found_manuscript.object }}
                <div class="flex mb-2 mx-2 gap-2">
                    {% comment %}
                        <form class="flex-0">
                            <input type="hidden" name="manifestation-link-type" value="is_part_of" />
                            <input type="hidden" name="manifestation-link" value="{{ found_manuscript.object.id }}" />
                            <input type="submit" class="btn btn-outline btn-sm" value="{% translate 'is part of' %}" />
                        </form>
                        <form class="flex-0">
                            <input type="hidden" name="manifestation-link-type" value="is_component_of" />
                            <input type="hidden" name="manifestation-link" value="{{ found_manuscript.object.id }}" />
                            <input type="submit" class="btn btn-outline btn-sm" value="{% translate 'is component of' %}" />
                        </form>
                    {% endcomment %}
                    <form class="flex-0">
                        <input type="hidden" name="manifestation-link-type" value="has_alternative" />
                        <input type="hidden" name="manifestation-link" value="{{ found_manuscript.object.id }}" />
                        <input type="submit" class="btn btn-outline btn-sm" value="{% translate 'has alternative' %}" />
                    </form>
                </div>
            </li>
        {% empty %}
            <li>
                <em>
                    {% translate 'no search results' %}
                </em>
            </li>
        {% endfor %}
    </ul>
{% endif %}

{% if manuscript_link %}
    <form method="post">
        {% csrf_token %}
        {{ object }} mit {{ manuscript_link }} verknüpfen als:
        {{ manuscript_link_form }}
        <input type="submit" class="btn" />
    </form>
{% endif %}

<h2 class="mb-5"> 
    {% translate 'prints' %}
</h2>

<h3>
    {% translate 'outbound' %}
</h3>

<em>
    {% translate 'links created by the search form will be displayed here' %}
</em>

<ul class="list-disc ml-5 my-5">
    {% for manifestation_relation in object.source_manifestation_of.all %}
        {% if not manifestation_relation.target_manifestation.is_singleton %}
            <li>
                <div class="flex items-center">
                    <a href="{% url 'edwoca:manifestation_relations' manifestation_relation.target_manifestation.id %}" class="flex-1">
                        {{ manifestation_relation.target_manifestation }} ({{ manifestation_relation.get_label_display }})
                    </a>
                    <form method="post" action="{% url 'edwoca:related_manifestation_remove' manifestation_relation.id %}" class="flex-0 ml-4">
                        {% csrf_token %}
                        <input type="submit" class="btn btn-sm btn-outline text-primary" value="{% translate 'remove' %}">
                    </form>
                </div>
            </li>
        {% endif %}
    {% endfor %}
</ul>

<h3>
    {% translate 'inbound' %}
</h3>
<em>
    {% translate 'prints linked to this object will be displayed here.' %}
</em>
<ul class="list-disc ml-5 my-5">
    {% for manifestation_relation in object.target_manifestation_of.all %}
        {% if not manifestation_relation.source_manifestation.is_singleton %}
            <li>
                <a href="{% url 'edwoca:manifestation_relations' manifestation_relation.source_manifestation.id %}" class="flex-1">
                    {{ manifestation_relation.source_manifestation }} ({{ manifestation_relation.get_label_display }})
                </a>
            </li>
        {% endif %}
    {% endfor %}
</ul>

<form action="{% url 'edwoca:manifestation_relations' object.id %}" method="get" class="w-full flex">
    {{ print_search_form.q }}
    <input type="submit" value="{% translate 'search' %}" class="btn btn-outline border-l-0" />
</form>

{% if print_query %}
    <ul class="border border-black p-2 h-32 overflow-auto">
        {% for found_print in found_prints %}
            <li>
                {{ found_print.object }}
                <div class="flex mb-2 mx-2 gap-2">
                    <form class="flex-0">
                        <input type="hidden" name="manifestation-link-type" value="is_part_of" />
                        <input type="hidden" name="manifestation-link" value="{{ found_print.object.id }}" />
                        <input type="submit" class="btn btn-outline btn-sm" value="{% translate 'is part of' %}" />
                    </form>
                    <form class="flex-0">
                        <input type="hidden" name="manifestation-link-type" value="is_component_of" />
                        <input type="hidden" name="manifestation-link" value="{{ found_print.object.id }}" />
                        <input type="submit" class="btn btn-outline btn-sm" value="{% translate 'is component of' %}" />
                    </form>
                    <form class="flex-0">
                        <input type="hidden" name="manifestation-link-type" value="has_alternative" />
                        <input type="hidden" name="manifestation-link" value="{{ found_print.object.id }}" />
                        <input type="submit" class="btn btn-outline btn-sm" value="{% translate 'has alternative' %}" />
                    </form>
                </div>
            </li>
        {% empty %}
            <li>
                <em>
                    {% translate 'no search results' %}
                </em>
            </li>
        {% endfor %}
    </ul>
{% endif %}

{% if not object.is_singleton %}
    <h2 class="my-5"> Exemplare </h2>
    {% if object.missing_item %}
        <p> Alle Exemplare dieses Drucks sind verschollen </p>
    {% else %}
        <div id="item-list-container">
            {% include 'edwoca/partials/manifestation/item_list.html' %}
        </div>
        <div class="flex mt-4">
            <div class="flex-1"></div>
            <a href="{% url 'edwoca:manifestation_item_create' object.id %}" class="btn flex-0"> neues Exemplar </a>
        </div>
    {% endif %}
{% endif %}

<h2 class="my-5"> 
    {% translate 'relations comment' %}
</h2>

<form method="post">
    {% csrf_token %}
    {{ relations_comment_form.as_daisy }}
    <input type="submit" id="submit-form" value="Speichern" class="hidden">
</form>

{% include 'edwoca/partials/manifestation/preview-divs/relations_epilog.html' %}

<div id="modal-container"></div>

{% endblock %}
